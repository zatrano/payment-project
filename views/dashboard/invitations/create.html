<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2 fw-bold">{{.Title}}</h1>
  <a href="/dashboard/invitations" class="btn btn-outline-primary d-flex align-items-center gap-2">
    <i class="bi bi-arrow-left"></i> Listeye Dön
  </a>
</div>

<div class="card card-glass mb-4">
  <div class="card-body">
    <form method="POST" action="/dashboard/invitations/create" id="invitation-form" enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ .CsrfToken }}">

      <div class="mb-4">
        <label for="categorySelect" class="form-label fw-bold fs-5">Kategori <span class="text-danger">*</span></label>
        <select id="categorySelect" name="category_id" class="form-select" required>
          <option value="">Lütfen Bir Kategori Seçiniz...</option>
          {{range .Categories.Data}}
            <option value="{{.ID}}" data-template="{{.Template}}" {{if eq .ID $.Invitation.CategoryID}}selected{{end}}>{{.Name}}</option>
          {{end}}
        </select>
      </div>

      <!-- Kategori seçildiğinde görünecek ana konteyner -->
      <div id="invitationRow" style="display:none">

        <div id="titleRow" class="mb-4" style="display:none">
          <label class="form-label">Başlık <span class="text-danger">*</span></label>
          <input type="text" name="detail[title]" class="form-control" value="{{.Invitation.InvitationDetail.Title}}">
        </div>

        <div id="personRow" class="mb-4" style="display:none">
          <label class="form-label">Kimin Adına? (Ad Soyad) <span class="text-danger">*</span></label>
          <input type="text" name="detail[person]" class="form-control" value="{{.Invitation.InvitationDetail.Person}}">
        </div>

        <div id="familyRow" class="row" style="display:none">
          <!-- Anne Bilgileri Grubu -->
          <div class="col-md-12">
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h5 class="mb-0">Anne Bilgileri</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-2 mb-3">
                    <label class="form-label">Anne Yaşıyor mu?</label>
                    <select name="detail[is_mother_live]" class="form-select">
                      <option value="">Seçiniz</option>
                      <option value="true" {{if eq .Invitation.InvitationDetail.IsMotherLive true}}selected{{end}}>Evet</option>
                      <option value="false" {{if eq .Invitation.InvitationDetail.IsMotherLive false}}selected{{end}}>Hayır</option>
                    </select>
                  </div>
                  <div class="col-md-5 mb-3">
                    <label class="form-label">Anne Adı <span class="text-danger">*</span></label>
                    <input type="text" name="detail[mother_name]" class="form-control" value="{{.Invitation.InvitationDetail.MotherName}}">
                  </div>
                  <div class="col-md-5 mb-3">
                    <label class="form-label">Anne Soyadı <span class="text-danger">*</span></label>
                    <input type="text" name="detail[mother_surname]" class="form-control" value="{{.Invitation.InvitationDetail.MotherSurname}}">
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Baba Bilgileri Grubu -->
          <div class="col-md-12">
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h5 class="mb-0">Baba Bilgileri</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-2 mb-3">
                    <label class="form-label">Baba Yaşıyor mu?</label>
                    <select name="detail[is_father_live]" class="form-select">
                      <option value="">Seçiniz</option>
                      <option value="true" {{if eq .Invitation.InvitationDetail.IsFatherLive true}}selected{{end}}>Evet</option>
                      <option value="false" {{if eq .Invitation.InvitationDetail.IsFatherLive false}}selected{{end}}>Hayır</option>
                    </select>
                  </div>
                  <div class="col-md-5 mb-3">
                    <label class="form-label">Baba Adı <span class="text-danger">*</span></label>
                    <input type="text" name="detail[father_name]" class="form-control" value="{{.Invitation.InvitationDetail.FatherName}}">
                  </div>
                  <div class="col-md-5 mb-3">
                    <label class="form-label">Baba Soyadı <span class="text-danger">*</span></label>
                    <input type="text" name="detail[father_surname]" class="form-control" value="{{.Invitation.InvitationDetail.FatherSurname}}">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="weddingRow" class="row" style="display:none">
          <!-- Gelin Bilgileri Grubu -->
          <div class="col-md-12">
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h5 class="mb-0">Gelin Bilgileri</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Adı <span class="text-danger">*</span></label>
                    <input type="text" name="detail[bride_name]" class="form-control" value="{{.Invitation.InvitationDetail.BrideName}}">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Soyadı <span class="text-danger">*</span></label>
                    <input type="text" name="detail[bride_surname]" class="form-control" value="{{.Invitation.InvitationDetail.BrideSurname}}">
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Annesi Yaşıyor mu?</label>
                    <select name="detail[is_bride_mother_live]" class="form-select">
                      <option value="">Seçiniz</option>
                      <option value="true" {{if eq .Invitation.InvitationDetail.IsBrideMotherLive true}}selected{{end}}>Evet</option>
                      <option value="false" {{if eq .Invitation.InvitationDetail.IsBrideMotherLive false}}selected{{end}}>Hayır</option>
                    </select>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Annesinin Adı</label>
                    <input type="text" name="detail[bride_mother_name]" class="form-control" value="{{.Invitation.InvitationDetail.BrideMotherName}}">
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Annesinin Soyadı</label>
                    <input type="text" name="detail[bride_mother_surname]" class="form-control" value="{{.Invitation.InvitationDetail.BrideMotherSurname}}">
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Babası Yaşıyor mu?</label>
                    <select name="detail[is_bride_father_live]" class="form-select">
                      <option value="">Seçiniz</option>
                      <option value="true" {{if eq .Invitation.InvitationDetail.IsBrideFatherLive true}}selected{{end}}>Evet</option>
                      <option value="false" {{if eq .Invitation.InvitationDetail.IsBrideFatherLive false}}selected{{end}}>Hayır</option>
                    </select>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Babasının Adı</label>
                    <input type="text" name="detail[bride_father_name]" class="form-control" value="{{.Invitation.InvitationDetail.BrideFatherName}}">
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Babasının Soyadı</label>
                    <input type="text" name="detail[bride_father_surname]" class="form-control" value="{{.Invitation.InvitationDetail.BrideFatherSurname}}">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Damat Bilgileri Grubu -->
          <div class="col-md-12">
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h5 class="mb-0">Damat Bilgileri</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Adı <span class="text-danger">*</span></label>
                    <input type="text" name="detail[groom_name]" class="form-control" value="{{.Invitation.InvitationDetail.GroomName}}">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Soyadı <span class="text-danger">*</span></label>
                    <input type="text" name="detail[groom_surname]" class="form-control" value="{{.Invitation.InvitationDetail.GroomSurname}}">
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Annesi Yaşıyor mu?</label>
                    <select name="detail[is_groom_mother_live]" class="form-select">
                      <option value="">Seçiniz</option>
                      <option value="true" {{if eq .Invitation.InvitationDetail.IsGroomMotherLive true}}selected{{end}}>Evet</option>
                      <option value="false" {{if eq .Invitation.InvitationDetail.IsGroomMotherLive false}}selected{{end}}>Hayır</option>
                    </select>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Annesinin Adı</label>
                    <input type="text" name="detail[groom_mother_name]" class="form-control" value="{{.Invitation.InvitationDetail.GroomMotherName}}">
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Annesinin Soyadı</label>
                    <input type="text" name="detail[groom_mother_surname]" class="form-control" value="{{.Invitation.InvitationDetail.GroomMotherSurname}}">
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Babası Yaşıyor mu?</label>
                    <select name="detail[is_groom_father_live]" class="form-select">
                      <option value="">Seçiniz</option>
                      <option value="true" {{if eq .Invitation.InvitationDetail.IsGroomFatherLive true}}selected{{end}}>Evet</option>
                      <option value="false" {{if eq .Invitation.InvitationDetail.IsGroomFatherLive false}}selected{{end}}>Hayır</option>
                    </select>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Babasının Adı</label>
                    <input type="text" name="detail[groom_father_name]" class="form-control" value="{{.Invitation.InvitationDetail.GroomFatherName}}">
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Babasının Soyadı</label>
                    <input type="text" name="detail[groom_father_surname]" class="form-control" value="{{.Invitation.InvitationDetail.GroomFatherSurname}}">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="mainRow" style="display:none">
          <hr class="my-4">
          
          <div class="mb-3">
            <label class="form-label">(RSVP/LCV) Katılımcılar bilgi versin mi? <span class="text-danger">*</span></label>
            <select name="is_participant" class="form-select" required>
              <option value="false" {{if eq .Invitation.IsParticipant false}}selected{{end}}>Hayır</option>
              <option value="true" {{if eq .Invitation.IsParticipant true}}selected{{end}}>Evet</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Davetiye tek kişilik mi? <span class="text-danger">*</span></label>
            <select name="is_multiple_participant" class="form-select" required>
              <option value="false" {{if eq .Invitation.IsMultipleParticipant false}}selected{{end}}>Hayır</option>
              <option value="true" {{if eq .Invitation.IsMultipleParticipant true}}selected{{end}}>Evet</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Davetiye Metni <span class="text-danger">*</span></label>
            <textarea name="description" class="form-control" rows="5" required>{{.Invitation.Description}}</textarea>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Tarih <span class="text-danger">*</span></label>
              <input type="date" name="date" class="form-control" value="{{.Invitation.Date}}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Saat <span class="text-danger">*</span></label>
              <input type="time" name="time" class="form-control" value="{{.Invitation.Time}}" required>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Not (İsteğe Bağlı)</label>
            <textarea name="note" class="form-control" rows="3">{{.Invitation.Note}}</textarea>
          </div>
          
          <div class="mb-3">
            <label class="form-label">İletişim Numarası <span class="text-danger">*</span></label>
            <input type="tel" name="telephone" id="telephone" class="form-control" value="{{.Invitation.Telephone}}" required>
          </div>
          
          <div id="linkRow" class="mb-3" style="display:none">
            <label class="form-label">Online Davetiye Linki <span class="text-danger">*</span></label>
            <input type="url" name="link" id="link_input" class="form-control" value="{{.Invitation.Link}}">
          </div>
          
          <div id="locationRow" class="mb-3" style="display:none">
            <label class="form-label">Konum (Google Haritalar)</label>
            <div class="row g-2 mb-2">
              <div class="col-12 col-md-6">
                <input type="text" class="form-control" id="venue_input" name="venue" placeholder="Lokasyon Adı" value="{{.Invitation.Venue}}">
              </div>
              <div class="col-12 col-md-6">
                <input type="text" class="form-control" id="address_input" name="address" placeholder="Açık Adres" value="{{.Invitation.Address}}">
              </div>
              <div class="col-12 mt-3">
                <button type="button" class="btn btn-outline-primary w-100" id="getEmbedCode">
                  <i class="bi bi-geo-alt-fill"></i> Konumu Kaydet
                </button>
              </div>
            </div>
            <input type="hidden" name="location" id="location" value="{{.Invitation.Location}}">
            <div id="mapContainer" class="mt-3 border rounded overflow-hidden d-none">
              <iframe id="mapFrame" style="width:100%; height:400px; border:none;" loading="lazy"></iframe>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Davetiye Resmi <span class="text-danger">*</span></label>
            <div class="alert alert-info">
              <i class="bi bi-info-circle-fill"></i> Lütfen dikey (portrait) formatta, 1080x1920 piksel boyutlarında ve 3MB'tan küçük bir resim yükleyin.
            </div>
            <input type="file" name="image" id="image" class="form-control" accept="image/*" required>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Türü</label>
            <select class="form-select" name="is_free" required>
              <option value="true" {{if or (not .Invitation) (eq .Invitation.IsFree true)}}selected{{end}}>
                Ücretsiz
              </option>
              <option value="false" {{if and .Invitation (eq .Invitation.IsFree false)}}selected{{end}}>
                Ücretli
              </option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Durum</label>
            <select class="form-select" name="is_confirmed" required>
              <option value="true" {{if or (not .Invitation) (eq .Invitation.IsConfirmed true)}}selected{{end}}>
                Aktif
              </option>
              <option value="false" {{if and .Invitation (eq .Invitation.IsConfirmed false)}}selected{{end}}>
                Pasif
              </option>
            </select>
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <a href="/dashboard/invitations" class="btn btn-secondary me-2">İptal</a>
          <button type="submit" id="saveButton" class="btn btn-primary">
            Kaydet
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Resim Önizleme Modalı -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Resim Önizleme</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="previewImage" src="" alt="Resim Önizleme" class="img-fluid rounded">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="changeImageBtn">
          <i class="bi bi-arrow-repeat"></i> Resmi Değiştir
        </button>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
          <i class="bi bi-check-circle-fill"></i> Onayla
        </button>
      </div>
    </div>
  </div>
</div>

<script src="/js/jquery-3.7.1.min.js"></script>
<script src="/js/jquery.inputmask.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    $('#telephone').inputmask("09999999999");
    var categorySelect = document.getElementById('categorySelect');
    var invitationRow = document.getElementById('invitationRow');
    var titleRow = document.getElementById('titleRow');
    var personRow = document.getElementById('personRow');
    var familyRow = document.getElementById('familyRow');
    var weddingRow = document.getElementById('weddingRow');
    var mainRow = document.getElementById('mainRow');
    var linkRow = document.getElementById('linkRow');
    var locationRow = document.getElementById('locationRow');
    var saveButton = document.getElementById('saveButton');

    categorySelect.addEventListener('change', function () {
      var selectedOption = categorySelect.options[categorySelect.selectedIndex];
      var template = selectedOption.getAttribute('data-template');

      // Tüm alanları gizle
      titleRow.style.display = 'none';
      personRow.style.display = 'none';
      familyRow.style.display = 'none';
      weddingRow.style.display = 'none';
      mainRow.style.display = 'block';
      linkRow.style.display = 'none';
      locationRow.style.display = 'none';

      if (template) {
        invitationRow.style.display = 'block';
        saveButton.style.display = 'block';
        switch (template) {
          case 'title':
            titleRow.style.display = 'block';
            locationRow.style.display = 'block';
            break;
          case 'online':
            titleRow.style.display = 'block';
            linkRow.style.display = 'block';
            locationRow.style.display = 'none';
            break;
          case 'person':
            personRow.style.display = 'block';
            locationRow.style.display = 'block';
            break;
          case 'person-family':
            personRow.style.display = 'block';
            familyRow.style.display = 'block';
            locationRow.style.display = 'block';
            break;
          case 'wedding':
            weddingRow.style.display = 'block';
            locationRow.style.display = 'block';
            break;
          default:
            invitationRow.style.display = 'none';
            break;
        }
      } else {
        invitationRow.style.display = 'none';
        mainRow.style.display = 'none';
        saveButton.style.display = 'none';
      }
    });

    if (categorySelect.value) {
      categorySelect.dispatchEvent(new Event('change'));
    }
    
    // Google Haritalar embed kodu oluşturma
    document.getElementById('getEmbedCode').addEventListener('click', function() {
        const venue = document.getElementById('venue_input').value.trim();
        const address = document.getElementById('address_input').value.trim();
        
        if (!venue || !address) {
            alert('Lütfen mekan adı ve adres bilgilerini giriniz!');
            return;
        }
        
        const query = encodeURIComponent(`${venue} ${address}`);
        const embedUrl = `https://www.google.com/maps?q=${query}&output=embed`;
        
        document.getElementById('location').value = embedUrl;
        document.getElementById('mapFrame').src = embedUrl;
        document.getElementById('mapContainer').classList.remove('d-none');
    });
    
    // Resim önizleme işlemleri
    const imageModal = new bootstrap.Modal('#imagePreviewModal');
    const imageInput = document.getElementById('image');
    const previewImage = document.getElementById('previewImage');
    
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Boyut kontrolü (3MB)
        if (file.size > 3 * 1024 * 1024) {
            alert('Resim boyutu 3MB\'dan büyük olamaz!');
            this.value = '';
            return;
        }
        
        // Önizleme göster
        previewImage.src = URL.createObjectURL(file);
        imageModal.show();
    });
    
    // Resmi değiştir butonu
    document.getElementById('changeImageBtn').addEventListener('click', function() {
        imageInput.value = '';
        imageModal.hide();
    });
    
    // Form gönderim validasyonu
    document.getElementById('invitation-form').addEventListener('submit', function(e) {
      var selectedOption = categorySelect.options[categorySelect.selectedIndex];
      var template = selectedOption.getAttribute('data-template');
      var errors = [];
      if (template === 'online') {
        var link = document.getElementById('link_input').value;
        if (!link) {
          errors.push('Online davetiye için link bilgisi zorunludur.');
        }
      } else {
        var venue = document.getElementById('venue_input').value;
        var address = document.getElementById('address_input').value;
        var location = document.getElementById('location').value;
        if (!venue) errors.push('Mekan adı zorunludur.');
        if (!address) errors.push('Adres bilgisi zorunludur.');
        if (!location) errors.push('Lütfen konum bilgisini kaydedin (Konumu Kaydet butonuna basın).');
      }
      if (errors.length > 0) {
        e.preventDefault();
        alert(errors.join('\n'));
      }
    });
});
</script>